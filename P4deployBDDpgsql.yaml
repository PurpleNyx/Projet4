---
- hosts: logipgsql
  tasks:

    # Mise à jour de base pour actualiser le conteneur
    - name: Mise à jour
      apt:
        force: yes
        upgrade: yes
        update_cache: yes


#########################################
#                                       #
### Partie I : Installation pgSQL BDD ###
#                                       #
#########################################


    # Installation de PyMySQL pour les manipulations de bases à l'aide d'Ansible
    - name: Installer PyMySQL
      apt:
        name: python-pymysql
        state: present

    # Installation de libpq-devpour les manipulations de bases à l'aide d'Ansible sur postgres
    - name: Installer libpq-dev
      apt:
        name: libpq-dev
        state: present

    # Installation de python-psycopg2 pour les manipulations de bases à l'aide d'Ansible sur postgres
    - name: Installer python-psycopg2
      apt:
        name: python-psycopg2
        state: present

    # Installation de postgresql
    - name: Installer postgresql
      apt:
        force: yes
        name: postgresql
        state: present

    # Ouverture de tous les ports d'écoute (inutile car déploiment du logiciel en local mais permet vérif à distance)
    # FAILLE FAILLE FAILLE FAILLE FAILLE FAILLE FAILLE FAILLE FAILLE FAILLE FAILLE FAILLE FAILLE FAILLE FAILLE
    # SECURITE SECURITE SECURITE SECURITE SECURITE SECURITE SECURITE SECURITE SECURITE SECURITE SECURITE SECURITE
    # FAILLE FAILLE FAILLE FAILLE FAILLE FAILLE FAILLE FAILLE FAILLE FAILLE FAILLE FAILLE FAILLE FAILLE FAILLE
    # SECURITE SECURITE SECURITE SECURITE SECURITE SECURITE SECURITE SECURITE SECURITE SECURITE SECURITE SECURITE
    - name: Changement config postgresql 
      shell: sed -i "s/^#listen_addresses =.*/listen_addresses = '0.0.0.0'/g" /etc/postgresql/9.5/main/postgresql.conf

    # Modification parce que postgresql aime être compliqué pour rien
    - name: modifier pg_hba.cnf pour connexion avec "postgres/postgres"
      shell: cd && cd /etc/postgresql/9.5/main && sed -i 's/^local   all             postgres                                peer/local   all             postgres                                trust/g' pg_hba.conf && sed -i 's/^local   all             all                                     peer/local   all             all                                     trust/g' pg_hba.conf && sed -i 's|^host    all             all             127.0.0.1/32            md5|host    all             all             0.0.0.0\/0           md5|g' pg_hba.conf && sed -i 's|^host    all             all             ::1/128                 md5|host    all             all             ::0/0          md5|g' pg_hba.conf

    # Démarrer le service postgresql
    - name: Démarrer postgresql
      service:
        name: postgresql
        state: restarted

    # Création d'un utilisateur autre que postgres pour utilisation ultérieure
    - name: Créer un utilisateur postgresql
      postgresql_user:
        login_user: postgres
        login_password: ''
        user: logicaldoc
        password: logicaldoc
        db: 'postgres'
        role_attr_flags: SUPERUSER
        state: present
      notify: user admin

    - name: Créer la base LogicalDoc
      postgresql_db:
        login_user: postgres
        name: logicaldoc

    - name: Dump la base LogicalDoc
      postgresql_db:
        login_user: postgres
        name: logicaldoc 
        state: restore


#########################################
#                                       #
## Partie II : Installation LogicalDoc ##
#                                       #
#########################################


    # Installation de java 8 pour Apache-Tomcat & LogicalDoc
    - name: Installer java 8
      apt:
        name: openjdk-8-jdk
        state: present

    # Récupération des sources d'Apache-Tomcat-8
    - name: Téléchargement et décompression de Apache-Tomcat-8.5.46
      unarchive: 
        src: http://apache.mirrors.benatherton.com/tomcat/tomcat-8/v8.5.46/bin/apache-tomcat-8.5.46.tar.gz
        dest: /home
        remote_src: yes

    # Téléchargement de LogicalDoc (module Ansible get_url non fonctionnel pour une exécution ultérieure dans Tomcat)
    - name: Téléchargement de LogicalDoc
      shell: cd /home/apache-tomcat-8.5.46/webapps && wget https://www.dropbox.com/s/cf999m4djxm6m7z/logicaldoc.war

    # Extraction du .war via jar
    - name: Extraction de logicaldoc.war
      shell: cd /home/apache-tomcat-8.5.46/webapps && mkdir logicaldoc && cd logicaldoc && jar -xvf /home/apache-tomcat-8.5.46/webapps/logicaldoc.war


#########################################
#                                       #
## Partie III : Paramétrage LogicalDoc ##
#                                       #
#########################################


    # Modification des fichiers de configuration de logicaldoc pour permettre la connexion à la base de données
    - name: Modification context.properties jdbc.dbms
      lineinfile:
        path: /home/apache-tomcat-8.5.46/webapps/logicaldoc/WEB-INF/classes/context.properties
        regexp: jdbc.dbms=hsqldb
        line: jdbc.dbms=postgres

    - name: Modification context.properties jdbc.driver
      lineinfile:
        path: /home/apache-tomcat-8.5.46/webapps/logicaldoc/WEB-INF/classes/context.properties
        regexp: jdbc.driver=org.hsqldb.jdbc.JDBCDriver
        line: jdbc.driver=org.postgresql.Driver

    - name: Modification context.properties jdbc.url
      lineinfile:
        path: /home/apache-tomcat-8.5.46/webapps/logicaldoc/WEB-INF/classes/context.properties
        regexp: jdbc.url=jdbc:hsqldb:mem:logicaldoc
        line: jdbc.url=jdbc:postgresql://localhost:5432/logicaldoc

    - name: Modification context.properties jdbc.password
      lineinfile:
        path: /home/apache-tomcat-8.5.46/webapps/logicaldoc/WEB-INF/classes/context.properties
        regexp: jdbc.password=
        line: jdbc.password=logicaldoc

    - name: Modification context.properties jdbc.username
      lineinfile:
        path: /home/apache-tomcat-8.5.46/webapps/logicaldoc/WEB-INF/classes/context.properties
        regexp: jdbc.username=sa 
        line: jdbc.username=logicaldoc


#########################################
#                                       #
#### Partie IV : Lancement du Tomcat ####
#                                       #
#########################################


    # Création d'un fichier de lancement de Apache-Tomcat
    # Nécessaire pour un lancement automatique sans dépassement de mémoire
    - name: Création fichier de lancement sh
      shell: echo "#!/bin/sh" > startall.sh

    - name: Ajout de l'option de séparation des processus
      shell: echo "set -m" >> startall.sh

    - name: Ajout du lancement de Apache-Tomcat-8
      shell: echo "sh /home/apache-tomcat-8.5.46/bin/startup.sh" >> startall.sh

    - name: Lancement de Apache-Tomcat-8
      shell: sh startall.sh
      register: TomcatLaunch
    - debug: var=TomcatLaunch


#########################################
#                                       #
########## Partie V : handlers ##########
#                                       #
#########################################


  handlers:
   - name: user admin
     debug:
       msg: L'utilisateur a été créé

   - name: faille
     debug:
       msg: FAILLE DE SECURITE PRESENTE SUR LA BASE DE DONNEES ! Si vous lisez ce message c'est que vous avez oublié de retirer l'ouverture de tous les ports de la BDD.